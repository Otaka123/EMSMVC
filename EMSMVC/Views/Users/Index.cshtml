
@model PagedResult<UserResponse>

@{
    ViewData["Title"] = "إدارة المستخدمين";
    Layout = "_Layout";
}

<div class="card shadow-lg border-0 rounded-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-users"></i> @ViewData["Title"]
        </h5>
        <div>
            <a  asp-action="Create" asp-controller="Users" class="btn btn-success">
                <i class="fas fa-plus-circle"></i> إضافة مستخدم
            </a>
            <a  asp-action="Index" asp-controller="Admin" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> رجوع
            </a>
        </div>
    </div>

    <div class="card-body">
        <!-- رسائل التنبيه -->
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> @TempData["Success"]
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> @TempData["Error"]
            </div>
        }

        <!-- جدول المستخدمين -->
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle text-center">
                <thead class="table-dark">
                    <tr>
                        <th>اسم المستخدم</th>
                        <th>البريد الإلكتروني</th>
                        <th>الاسم الكامل</th>
                        <th>الأدوار</th>
                        <th>الحالة</th>
                        <th>آخر دخول</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model.Items)
                    {
                        <tr>
                            <td>@user.UserName</td>
                            <td>@user.Email</td>
                            <td>@user.FullName</td>
                            <td>
                                @if (user.Roles != null && user.Roles.Any())
                                {
                                    foreach (var role in user.Roles)
                                    {
                                        <span class="badge bg-primary me-1">@role</span>
                                    }
                                }
                                else
                                {
                                    <span class="badge bg-secondary">لا يوجد أدوار</span>
                                }
                            </td>
                            <td>
                                @if (user.IsActive)
                                {
                                    <span class="badge bg-success">نشط</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">غير نشط</span>
                                }
                            </td>
                            <td>
                                @if (user.LastLoginDate.HasValue)
                                {
                                    @user.LastLoginDate.Value.ToString("yyyy/MM/dd HH:mm")
                                }
                                else
                                {
                                    <span class="text-muted">لم يسجل دخول</span>
                                }
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- تعديل -->
                                    <a  asp-action="Edit" asp-route-id="@user.Id" class="btn btn-warning">
                                        <i class="fas fa-edit"></i> تعديل
                                    </a>
                                    <!-- الأدوار -->
                                    <a  asp-controller="Users" asp-action="ManageRoles" asp-route-userId="@user.Id" class="btn btn-info text-white">
                                        <i class="fas fa-user-tag"></i> الأدوار
                                    </a>
                                    <!-- حذف -->
                                    <form asp-controller="Users" asp-action="Delete" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="userId" value="@user.Id" />
                                        <button type="submit" class="btn btn-outline-danger"
                                                onclick="return confirmDelete('@user.UserName')">
                                            <i class="fas fa-trash"></i> حذف
                                        </button>
                                    </form>

                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalCount > 0)
        {
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    @{
                        var currentPage = Model.PageNumber;
                        var totalPages = (int)Math.Ceiling((double)Model.TotalCount / Model.PageSize);
                        var queryString = Context.Request.QueryString;
                    }

                    @if (currentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { pageNumber = currentPage - 1, pageSize = Model.PageSize })@queryString">
                                <i class="fas fa-chevron-right"></i> السابق
                            </a>
                        </li>
                    }

                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { pageNumber = i, pageSize = Model.PageSize })@queryString">@i</a>
                        </li>
                    }

                    @if (currentPage < totalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { pageNumber = currentPage + 1, pageSize = Model.PageSize })@queryString">
                                التالي <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>

            <div class="text-center text-muted">
                عرض @((currentPage - 1) * Model.PageSize + 1) إلى @Math.Min(currentPage * Model.PageSize, Model.TotalCount) من @Model.TotalCount مستخدم
            </div>
        }
        else
        {
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i> لا توجد مستخدمين لعرضهم
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function confirmDelete(userName) {
            return confirm(`هل أنت متأكد من حذف المستخدم "${userName}"؟ هذا الإجراء لا يمكن التراجع عنه.`);
        }
    </script>
}
